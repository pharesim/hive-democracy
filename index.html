<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hive Democracy Checker</title>
    <script>
        const countriesData = [
            { "country": "Afghanistan", "eligible_voters": 7000000 },
            { "country": "Algeria", "eligible_voters": 23000000 },
            { "country": "Argentina", "eligible_voters": 33000000 },
            { "country": "Australia", "eligible_voters": 18000000 },
            { "country": "Bangladesh", "eligible_voters": 104000000 },
            { "country": "Belgium", "eligible_voters": 8500000 },
            { "country": "Brazil", "eligible_voters": 147000000 },
            { "country": "Canada", "eligible_voters": 27000000 },
            { "country": "Chile", "eligible_voters": 15000000 },
            { "country": "China", "eligible_voters": 1400000000 },
            { "country": "Colombia", "eligible_voters": 15000000 },
            { "country": "Cuba", "eligible_voters": 8000000 },
            { "country": "Czech Republic", "eligible_voters": 8500000 },
            { "country": "Egypt", "eligible_voters": 70000000 },
            { "country": "France", "eligible_voters": 50700000 },
            { "country": "Germany", "eligible_voters": 65100000 },
            { "country": "Ghana", "eligible_voters": 18000000 },
            { "country": "Greece", "eligible_voters": 9700000 },
            { "country": "India", "eligible_voters": 968000000 },
            { "country": "Indonesia", "eligible_voters": 190000000 },
            { "country": "Iran", "eligible_voters": 56000000 },
            { "country": "Iraq", "eligible_voters": 13000000 },
            { "country": "Italy", "eligible_voters": 47300000 },
            { "country": "Japan", "eligible_voters": 105000000 },
            { "country": "Kenya", "eligible_voters": 19000000 },
            { "country": "Malaysia", "eligible_voters": 15000000 },
            { "country": "Mexico", "eligible_voters": 93000000 },
            { "country": "Morocco", "eligible_voters": 18000000 },
            { "country": "Nepal", "eligible_voters": 12000000 },
            { "country": "Nigeria", "eligible_voters": 84000000 },
            { "country": "Pakistan", "eligible_voters": 127000000 },
            { "country": "Peru", "eligible_voters": 25000000 },
            { "country": "Philippines", "eligible_voters": 67500000 },
            { "country": "Poland", "eligible_voters": 30000000 },
            { "country": "Portugal", "eligible_voters": 9600000 },
            { "country": "Romania", "eligible_voters": 18900000 },
            { "country": "Russia", "eligible_voters": 111000000 },
            { "country": "Saudi Arabia", "eligible_voters": 3000000 },
            { "country": "South Africa", "eligible_voters": 26000000 },
            { "country": "South Korea", "eligible_voters": 44000000 },
            { "country": "Sri Lanka", "eligible_voters": 17100000 },
            { "country": "Sudan", "eligible_voters": 12000000 },
            { "country": "Tanzania", "eligible_voters": 15000000 },
            { "country": "Thailand", "eligible_voters": 52000000 },
            { "country": "Turkey", "eligible_voters": 60000000 },
            { "country": "Ukraine", "eligible_voters": 20000000 },
            { "country": "United Kingdom", "eligible_voters": 47000000 },
            { "country": "United States", "eligible_voters": 250000000 },
            { "country": "Uzbekistan", "eligible_voters": 10000000 },
            { "country": "Venezuela", "eligible_voters": 21000000 },
            { "country": "Vietnam", "eligible_voters": 69000000 },
            { "country": "Zimbabwe", "eligible_voters": 10000000 }
        ];

        const totalHivePower = 181000000;

        const countriesWithArticle = ["United States", "United Kingdom", "Netherlands", "Philippines", "Czech Republic"];

        async function getGlobalProperties() {
            const response = await fetch(`https://api.hive.blog`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    jsonrpc: "2.0",
                    method: "condenser_api.get_dynamic_global_properties",
                    params: [],
                    id: 1
                })
            });
            const data = await response.json();
            return [parseFloat(data.result.total_vesting_fund_hive.split(" ")[0]),parseFloat(data.result.total_vesting_shares.split(" ")[0])];
        }

        async function getAccountHP(accountName) {
            const response = await fetch(`https://api.hive.blog`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    jsonrpc: "2.0",
                    method: "condenser_api.get_accounts",
                    params: [[accountName]],
                    id: 1
                })
            });
            const data = await response.json();
            const account = data.result[0];
            if (account) {
                const vestingShares = parseFloat(account.vesting_shares.split(" ")[0]);
                const totalVestingFundHive = await getGlobalProperties();
                return vestingShares * totalVestingFundHive[0] / totalVestingFundHive[1];
            }
            return null;
        }

        async function getGroupHP(accountNames) {
            const accounts = accountNames.split(',').map(name => name.trim());
            let totalHP = 0;

            for (const account of accounts) {
                const hp = await getAccountHP(account);
                if (hp !== null) {
                    totalHP += hp;
                }
            }

            return totalHP;
        }

        async function calculateVotes() {
            const dropdown = document.getElementById('countryDropdown');
            const voters = dropdown.value;
            const input = document.getElementById('hpInput').value.trim();
            const votesDisplay = document.getElementById('votesInfo');
            const selectedCountry = dropdown.options[dropdown.selectedIndex]?.text;

            if (!voters || !input) {
                votesDisplay.textContent = '';
                return;
            }

            let hp = parseFloat(input);
            let isGroup = false;

            if (isNaN(hp)) {
                isGroup = input.includes(',');
                hp = isGroup ? await getGroupHP(input) : await getAccountHP(input);
                if (hp === null || hp === 0) {
                    votesDisplay.textContent = `Account(s) "${input}" not found or invalid.`;
                    return;
                }
            }

            const votes = (hp / totalHivePower) * voters;
            const countryName = countriesWithArticle.includes(selectedCountry) ? `the ${selectedCountry}` : selectedCountry;
            const prefix = isGroup ? `The group's` : `Your`;

            const locale = dropdown.options[dropdown.selectedIndex]?.dataset.locale || 'en-US';
            const formattedHP = new Intl.NumberFormat(locale).format(hp.toFixed(2));
            const formattedVotes = new Intl.NumberFormat(locale).format(Math.floor(votes));

            votesDisplay.textContent = `${prefix} vote on Hive with ${formattedHP} HP has as much influence as ${formattedVotes} votes in the general elections of ${countryName}.`;
        }

        function loadCountries() {
            const dropdown = document.getElementById('countryDropdown');
            countriesData.forEach(country => {
                const option = document.createElement('option');
                option.value = country.eligible_voters;
                option.textContent = country.country;
                option.dataset.locale = getLocaleForCountry(country.country);
                dropdown.appendChild(option);
            });

            preselectCountry();
        }

        function getLocaleForCountry(country) {
            const locales = {
                "Afghanistan": "fa-AF",
                "Algeria": "ar-DZ",
                "Argentina": "es-AR",
                "Australia": "en-AU",
                "Bangladesh": "bn-BD",
                "Belgium": "nl-BE",
                "Brazil": "pt-BR",
                "Canada": "en-CA",
                "Chile": "es-CL",
                "China": "zh-CN",
                "Colombia": "es-CO",
                "Cuba": "es-CU",
                "Czech Republic": "cs-CZ",
                "Egypt": "ar-EG",
                "France": "fr-FR",
                "Germany": "de-DE",
                "Ghana": "en-GH",
                "Greece": "el-GR",
                "India": "en-IN",
                "Indonesia": "id-ID",
                "Iran": "fa-IR",
                "Iraq": "ar-IQ",
                "Italy": "it-IT",
                "Japan": "ja-JP",
                "Kenya": "en-KE",
                "Malaysia": "ms-MY",
                "Mexico": "es-MX",
                "Morocco": "ar-MA",
                "Nepal": "ne-NP",
                "Nigeria": "en-NG",
                "Pakistan": "ur-PK",
                "Peru": "es-PE",
                "Philippines": "en-PH",
                "Poland": "pl-PL",
                "Portugal": "pt-PT",
                "Romania": "ro-RO",
                "Russia": "ru-RU",
                "Saudi Arabia": "ar-SA",
                "South Africa": "en-ZA",
                "South Korea": "ko-KR",
                "Sri Lanka": "si-LK",
                "Sudan": "ar-SD",
                "Tanzania": "sw-TZ",
                "Thailand": "th-TH",
                "Turkey": "tr-TR",
                "Ukraine": "uk-UA",
                "United Kingdom": "en-GB",
                "United States": "en-US",
                "Uzbekistan": "uz-UZ",
                "Venezuela": "es-VE",
                "Vietnam": "vi-VN",
                "Zimbabwe": "en-ZW"
            };
            return locales[country] || "en-US";
        }

        function preselectCountry() {
            const userLocale = navigator.language || "en-US";
            const countryFromLocale = getCountryFromLocale(userLocale);
            const dropdown = document.getElementById('countryDropdown');
            const options = Array.from(dropdown.options);
            const match = options.find(option => option.textContent === countryFromLocale);

            if (match) {
                dropdown.value = match.value;
            } else {
                dropdown.value = options.find(option => option.textContent === "United States").value;
            }

            calculateVotes();
        }

        function getCountryFromLocale(locale) {
            const localeToCountry = {
                "fa-AF": "Afghanistan",
                "ar-DZ": "Algeria",
                "es-AR": "Argentina",
                "en-AU": "Australia",
                "bn-BD": "Bangladesh",
                "nl-BE": "Belgium",
                "pt-BR": "Brazil",
                "en-CA": "Canada",
                "es-CL": "Chile",
                "zh-CN": "China",
                "es-CO": "Colombia",
                "es-CU": "Cuba",
                "cs-CZ": "Czech Republic",
                "ar-EG": "Egypt",
                "fr-FR": "France",
                "de-DE": "Germany",
                "en-GH": "Ghana",
                "el-GR": "Greece",
                "en-IN": "India",
                "id-ID": "Indonesia",
                "fa-IR": "Iran",
                "ar-IQ": "Iraq",
                "it-IT": "Italy",
                "ja-JP": "Japan",
                "en-KE": "Kenya",
                "ms-MY": "Malaysia",
                "es-MX": "Mexico",
                "ar-MA": "Morocco",
                "ne-NP": "Nepal",
                "en-NG": "Nigeria",
                "ur-PK": "Pakistan",
                "es-PE": "Peru",
                "en-PH": "Philippines",
                "pl-PL": "Poland",
                "pt-PT": "Portugal",
                "ro-RO": "Romania",
                "ru-RU": "Russia",
                "ar-SA": "Saudi Arabia",
                "en-ZA": "South Africa",
                "ko-KR": "South Korea",
                "si-LK": "Sri Lanka",
                "ar-SD": "Sudan",
                "sw-TZ": "Tanzania",
                "th-TH": "Thailand",
                "tr-TR": "Turkey",
                "uk-UA": "Ukraine",
                "en-GB": "United Kingdom",
                "en-US": "United States",
                "uz-UZ": "Uzbekistan",
                "es-VE": "Venezuela",
                "vi-VN": "Vietnam",
                "en-ZW": "Zimbabwe"
            };
            return localeToCountry[locale] || "United States";
        }

        window.onload = loadCountries;
    </script>
</head>
<body>
    <h1>Hive Democracy Checker</h1>
    <label for="hpInput">Staked Hive Power (HP), Account Name, or Group (comma-separated):</label>
    <input type="text" id="hpInput" oninput="calculateVotes()" placeholder="Enter HP, account name, or group" />
    <br />
    <label for="countryDropdown">Select a country:</label>
    <select id="countryDropdown" onchange="calculateVotes()">
        <option value="">--Select a country--</option>
    </select><br />

    <p id="votesInfo"></p>
    <footer>
        <p>Created by <a href="http://pharesim.me" target="_blank">@pharesim</a></p>
        <p><a href="https://github.com/pharesim/hive-democracy" target="_blank">GitHub</a></p>
    </footer>
</body>
</html>
