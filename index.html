<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hive Democracy Checker</title>
    <script>
        const countriesData = [
            { "country": "Afghanistan", "eligible_voters": 7000000 },
            { "country": "Algeria", "eligible_voters": 23000000 },
            { "country": "Argentina", "eligible_voters": 33000000 },
            { "country": "Australia", "eligible_voters": 18000000 },
            { "country": "Bangladesh", "eligible_voters": 104000000 },
            { "country": "Belgium", "eligible_voters": 8500000 },
            { "country": "Brazil", "eligible_voters": 147000000 },
            { "country": "Canada", "eligible_voters": 27000000 },
            { "country": "Chile", "eligible_voters": 15000000 },
            { "country": "China", "eligible_voters": 1400000000 },
            { "country": "Colombia", "eligible_voters": 15000000 },
            { "country": "Cuba", "eligible_voters": 8000000 },
            { "country": "Czech Republic", "eligible_voters": 8500000 },
            { "country": "Egypt", "eligible_voters": 70000000 },
            { "country": "France", "eligible_voters": 50700000 },
            { "country": "Germany", "eligible_voters": 65100000 },
            { "country": "Ghana", "eligible_voters": 18000000 },
            { "country": "Greece", "eligible_voters": 9700000 },
            { "country": "India", "eligible_voters": 968000000 },
            { "country": "Indonesia", "eligible_voters": 190000000 },
            { "country": "Iran", "eligible_voters": 56000000 },
            { "country": "Iraq", "eligible_voters": 13000000 },
            { "country": "Italy", "eligible_voters": 47300000 },
            { "country": "Japan", "eligible_voters": 105000000 },
            { "country": "Kenya", "eligible_voters": 19000000 },
            { "country": "Malaysia", "eligible_voters": 15000000 },
            { "country": "Mexico", "eligible_voters": 93000000 },
            { "country": "Morocco", "eligible_voters": 18000000 },
            { "country": "Nepal", "eligible_voters": 12000000 },
            { "country": "Nigeria", "eligible_voters": 84000000 },
            { "country": "Pakistan", "eligible_voters": 127000000 },
            { "country": "Peru", "eligible_voters": 25000000 },
            { "country": "Philippines", "eligible_voters": 67500000 },
            { "country": "Poland", "eligible_voters": 30000000 },
            { "country": "Portugal", "eligible_voters": 9600000 },
            { "country": "Romania", "eligible_voters": 18900000 },
            { "country": "Russia", "eligible_voters": 111000000 },
            { "country": "Saudi Arabia", "eligible_voters": 3000000 },
            { "country": "South Africa", "eligible_voters": 26000000 },
            { "country": "South Korea", "eligible_voters": 44000000 },
            { "country": "Sri Lanka", "eligible_voters": 17100000 },
            { "country": "Sudan", "eligible_voters": 12000000 },
            { "country": "Tanzania", "eligible_voters": 15000000 },
            { "country": "Thailand", "eligible_voters": 52000000 },
            { "country": "Turkey", "eligible_voters": 60000000 },
            { "country": "Ukraine", "eligible_voters": 20000000 },
            { "country": "United Kingdom", "eligible_voters": 47000000 },
            { "country": "United States", "eligible_voters": 250000000 },
            { "country": "Uzbekistan", "eligible_voters": 10000000 },
            { "country": "Venezuela", "eligible_voters": 21000000 },
            { "country": "Vietnam", "eligible_voters": 69000000 },
            { "country": "Zimbabwe", "eligible_voters": 10000000 }
        ];

        const totalHivePower = 181000000;

        const countriesWithArticle = ["United States", "United Kingdom", "Netherlands", "Philippines", "Czech Republic"];

        async function getGlobalProperties() {
            const response = await fetch(`https://api.hive.blog`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    jsonrpc: "2.0",
                    method: "condenser_api.get_dynamic_global_properties",
                    params: [],
                    id: 1
                })
            });
            const data = await response.json();
            return [parseFloat(data.result.total_vesting_fund_hive.split(" ")[0]),parseFloat(data.result.total_vesting_shares.split(" ")[0])];
        }

        async function getAccountHP(accountName) {
            const response = await fetch(`https://api.hive.blog`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    jsonrpc: "2.0",
                    method: "condenser_api.get_accounts",
                    params: [[accountName]],
                    id: 1
                })
            });
            const data = await response.json();
            const account = data.result[0];
            if (account) {
                const vestingShares = parseFloat(account.vesting_shares.split(" ")[0]);
                const totalVestingFundHive = await getGlobalProperties();
                return vestingShares * totalVestingFundHive[0] / totalVestingFundHive[1];
            }
            return null;
        }

        async function calculateVotes() {
            const dropdown = document.getElementById('countryDropdown');
            const voters = dropdown.value;
            const input = document.getElementById('hpInput').value.trim();
            const votesDisplay = document.getElementById('votesInfo');
            const selectedCountry = dropdown.options[dropdown.selectedIndex]?.text;

            if (!voters || !input) {
                votesDisplay.textContent = '';
                return;
            }

            let hp = parseFloat(input);
            let accountName = null;

            if (isNaN(hp)) {
                accountName = input;
                hp = await getAccountHP(accountName);
                if (hp === null) {
                    votesDisplay.textContent = `Account "${accountName}" not found or invalid.`;
                    return;
                }
            }

            const votes = (hp / totalHivePower) * voters;
            const countryName = countriesWithArticle.includes(selectedCountry) ? `the ${selectedCountry}` : selectedCountry;
            const prefix = accountName ? `@${accountName}'s` : `Your`;

            const locale = dropdown.options[dropdown.selectedIndex]?.dataset.locale || 'en-US';
            const formattedHP = new Intl.NumberFormat(locale).format(hp.toFixed(2));
            const formattedVotes = new Intl.NumberFormat(locale).format(Math.floor(votes));

            votesDisplay.textContent = `${prefix} vote on Hive with ${formattedHP} HP has as much influence as ${formattedVotes} votes in the general elections of ${countryName}.`;
        }

        function loadCountries() {
            const dropdown = document.getElementById('countryDropdown');
            countriesData.forEach(country => {
                const option = document.createElement('option');
                option.value = country.eligible_voters;
                option.textContent = country.country;
                option.dataset.locale = getLocaleForCountry(country.country);
                dropdown.appendChild(option);
            });

            preselectCountry();
        }

        function getLocaleForCountry(country) {
            const locales = {
                "United States": "en-US",
                "United Kingdom": "en-GB",
                "Germany": "de-DE",
                "France": "fr-FR",
                "India": "en-IN",
            };
            return locales[country] || "en-US";
        }

        async function preselectCountry() {
            try {
                const response = await fetch("https://ipapi.co/json/");
                const data = await response.json();
                const userCountry = data.country_name || "United States";
                const dropdown = document.getElementById('countryDropdown');
                const options = Array.from(dropdown.options);
                const match = options.find(option => option.textContent === userCountry);
                if (match) {
                    dropdown.value = match.value;
                } else {
                    dropdown.value = options.find(option => option.textContent === "United States").value;
                }
                calculateVotes();
            } catch (error) {
                console.error("Could not determine user location, defaulting to United States.");
                const dropdown = document.getElementById('countryDropdown');
                dropdown.value = Array.from(dropdown.options).find(option => option.textContent === "United States").value;
                calculateVotes();
            }
        }

        window.onload = loadCountries;
    </script>
</head>
<body>
    <h1>Hive Democracy Checker</h1>
    <label for="hpInput">Staked Hive Power (HP) or Account Name:</label>
    <input type="text" id="hpInput" oninput="calculateVotes()" placeholder="Enter HP or account name" />
    <br />
    <label for="countryDropdown">Select a country:</label>
    <select id="countryDropdown" onchange="calculateVotes()">
        <option value="">--Select a country--</option>
    </select><br />

    <p id="votesInfo"></p>
    <footer>
        <p>Created by <a href="http://pharesim.me" target="_blank">@pharesim</a></p>
        <p><a href="https://github.com/pharesim/hive-democracy" target="_blank">GitHub</a></p>
    </footer>
</body>
</html>
